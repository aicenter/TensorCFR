#!/usr/bin/env python3

import logging

from src.algorithms.tensorcfr_best_response.TensorCFR_BestResponse import TensorCFR_BestResponse
from src.commons.constants import PLAYER1, PLAYER2, DEFAULT_TOTAL_STEPS, DEFAULT_AVERAGING_DELAY
from src.utils.other_utils import get_current_timestamp


class ExploitabilityByTensorCFR:
	def __init__(self, domain, trunk_depth, trunk_strategies, total_steps=DEFAULT_TOTAL_STEPS,
	             delay=DEFAULT_AVERAGING_DELAY, log_lvl=logging.WARNING):
		log_filename = "logs/{}_{}_td{}_{}.log".format(self.__class__.__name__, domain.domain_name, trunk_depth,
		                                               get_current_timestamp())
		logging.basicConfig(filename=log_filename, format='%(asctime)s %(message)s', level=log_lvl)

		self._domain = domain
		self._trunk_depth = trunk_depth
		self._trunk_strategies = trunk_strategies
		self._total_steps = total_steps
		self._delay = delay
		self.compute_best_response_values()
		self.compute_exploitabilities()

	def compute_best_response_values(self):
		self.tensorcfr_br_player1 = TensorCFR_BestResponse(
			best_responder=PLAYER1,
			trunk_strategies=self._trunk_strategies,
			domain=self._domain,
			trunk_depth=self._trunk_depth
		)
		self.tensorcfr_br_player2 = TensorCFR_BestResponse(
			best_responder=PLAYER2,
			trunk_strategies=self._trunk_strategies,
			domain=self._domain,
			trunk_depth=self._trunk_depth
		)

		register_strategies_on_step1 = [0, 2, 4, 6, 8]
		self.final_brvalue_1 = self.tensorcfr_br_player1.get_final_best_response_value(
			total_steps=self._total_steps,
			delay=self._delay,
			register_strategies_on_step=register_strategies_on_step1
		)
		register_strategies_on_step2 = [1, 3, 5, 7, 9]
		self.final_brvalue_2 = self.tensorcfr_br_player2.get_final_best_response_value(
			total_steps=self._total_steps,
			delay=self._delay,
			register_strategies_on_step=register_strategies_on_step2
		)

		logging.info("Average strategies (player 1) over steps {}:\n{}".format(
			register_strategies_on_step1,
			self.tensorcfr_br_player1.average_strategies_over_steps
		))
		logging.info("Average strategies (player 2) over steps {}:\n{}".format(
			register_strategies_on_step2,
			self.tensorcfr_br_player2.average_strategies_over_steps
		))

	def compute_exploitabilities(self):
		self.final_exploitability = (self.final_brvalue_1 + self.final_brvalue_2) / 2
